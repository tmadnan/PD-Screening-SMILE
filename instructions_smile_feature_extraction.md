# Extracting Facial Action Units and Features Using OpenFace

## **Step 1: Extracting Facial Action Units Using OpenFace**

### Prerequisites:
- The following instructions are executed on a **Windows machine** (recommended to avoid complexity).

---

### **Instructions**:

1. **Download OpenFace**:
   - Download the 64-bit Windows binary for OpenFace from the following link:  
     [OpenFace 2.2.0 (64-bit Windows)](https://github.com/TadasBaltrusaitis/OpenFace/releases/download/OpenFace_2.2.0/OpenFace_2.2.0_win_x64.zip).

2. **Unzip the File**:
   - Unzip the downloaded `.zip` file.
   - Navigate to the extracted folder named `OpenFace_2.2.0_win_x64`.

3. **Open PowerShell in Administrator Mode**:
   - Open a **PowerShell window** inside the `OpenFace_2.2.0_win_x64` folder **as Administrator**.

4. **Run `download_libraries.ps1`**:
   - Run the script `download_libraries.ps1` to download and configure required libraries.  
     Use the following command in PowerShell:
     ```powershell
     powershell -ExecutionPolicy Bypass -File "download_models.ps1"
     ```
     - **Note**: This step requires Administrator mode as it overrides regular access permissions.

5. **Prepare Video Files**:
   - Create a folder (e.g., `videos`) in the same `OpenFace_2.2.0_win_x64` directory.
   - Inside this folder, place all the video files you want to extract Action Units from.

6. **Create and Run a PowerShell Script**:
   - Create a `au_extract.ps1` script with the following content to process all video files in the `videos` folder:
     ```powershell
     $input_folder = ".\\videos"
     Get-ChildItem -Path $input_folder | ForEach-Object {
         .\\FeatureExtraction.exe -f $_.FullName -aus
     }
     ```
   - Run the script ``au_extract.ps1`` using the following command in PowerShell:
     ```powershell
     powershell -ExecutionPolicy Bypass -File "au_extract.ps1"
     ```
   - This script will:
     - Iterate through all video files in the `videos` folder.
     - Run `FeatureExtraction.exe` to extract Action Units.
     - Save the extracted features in CSV format inside the `processed` folder created automatically by OpenFace.

---

## **Step 2: Extracting Features**

### Prerequisites:
- This step uses the **CSV files generated by OpenFace** for Action Units and the **raw video files** for landmark features.

---

### **Recommended Folder Structure**:

```plaintext
parent_directory/
├── openface_extracts/       # Contains CSV files from OpenFace
├── raw_videos/              # Contains raw video files
├── extracted_features/      # Output folder for extracted features
├── smile_feature_extraction.py
```


1. **`openface_extracts`**:
   - Place all the CSV files generated by OpenFace in this folder.

2. **`raw_videos`**:
   - Place all the raw video files in this folder.

3. **File Naming Convention**:
   - Ensure that files in `openface_extracts` and `raw_videos` differ only by the file format.  
     For example:
     - `example_video.csv` in `openface_extracts`
     - `example_video.mp4` in `raw_videos`.

4. **`smile_feature_extraction.py`**:
   - Place the Python script (`smile_feature_extraction.py`) in the ``parent_directory`` folder.

5. **`extracted_features`**:
   - Create another folder named `extracted_features` in the ``parent_directory``. This is where the extracted features will be saved.

---

### **Installing Required Python Libraries**

Before running the `smile_feature_extraction.py` script, ensure you have the following Python libraries installed.

To install them, you can use the following commands in a terminal:

```python
# Install core libraries
pip install opencv-python mediapipe tqdm protobuf pandas numpy scipy scikit-learn argparse

# Install additional libraries
pip install protobuf3-to-dict
```

### **Feature Extraction Command**:
Run the following command in the terminal from the ``parent_directory``:
```bash
python smile_feature_extraction.py --video_files_directory=raw_videos --openface_files_directory=openface_extracts --output_dir=extracted_features 2>/dev/null
```
**Note**: This command suppresses all warnings generated by MediaPipe during code execution to keep the output clean and focused.